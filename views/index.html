<!DOCTYPE html>
<html>

<head>
    <title>NodeJS: {{title}}</title>
    
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9a2e1c8b0bd726e6522013b770aef13f&libraries=services"></script>

    <style>
        #map {
            width: 500px;
            height: 400px;
        }
    </style>

</head>

<body>

    <!-- //전체리뷰
        <p>
        <a href="http://localhost:{{port}}/users">http://localhost:{{port}}/users</a><br> 
        <a href="http://localhost:{{port}}/comments">http://localhost:{{port}}/comments</a><br>   
        <a href="http://localhost:{{port}}/data">http://localhost:{{port}}/data</a>
    </p>  -->

    
    <p>
        <a href="http://localhost:{{port}}/user">마이페이지</a><br>
    </p>

    <p>
        <a href="http://localhost:{{port}}/comment">리뷰작성</a><br>
    </p>

    <p>
        {% if user %}
            {% if user.description.startsWith('http') %}

                <img src="{{user.description}}" width="100" height="100">
                
            {% endif %}
            {{user.name}}님 환영합니다!<br>
            <a href="http://localhost:{{port}}/auth/logout">로그아웃</a>

            <!-- 주소지 입력으로 검색 가능, ※ 건물 이름 불가 -->
            <p>
                <input type="text" id="addressInput" placeholder="주소를 입력하세요">
                <button id="searchBtn">주소 검색</button>
                <div id="result"></div>
                <div id="map"></div>
            </p>

            <p id="reviewInput" style="display:none;">
                <textarea id="reviewTextArea" placeholder="리뷰를 작성하세요"></textarea><br>
                <button id="postReviewBtn" onclick="postReview()">리뷰 작성</button>
            </p>

        {% else %}

        <form id="form" action="auth/login" method="post">
            <input type="text" name="id" placeholder="ID" /><br>
            <input type="text" name="password" placeholder="Password" /><br>
            <button type="submit">로그인</button>
        </form>

        {% endif %}

    </p>

    <script>
        //페이지에 searchAddress() 로드
        window.onload = function () {
            document.getElementById('searchBtn').onclick = function () {
                searchAddress();
            };
        };

        //kakao Map APi를 통한 검색이 유용한 경우 검색한 주소의 위도와 경도를 가져옴.
        function searchAddress() {
            var address = document.getElementById('addressInput').value;
            var geocoder = new kakao.maps.services.Geocoder();

            
            geocoder.addressSearch(address, function (result, status) {
                
                // 주소 검색 결과가 성공적으로 반환되었는지 확인합니다.
                if (status === kakao.maps.services.Status.OK) {
                    var searchedLat = result[0].y; // 검색한 장소의 위도
                    var searchedLng = result[0].x; // 검색한 장소의 경도

                    //사용자의 현재 위도와 경도를 가져오는 함수이며, 조건에 따른 결과 출력.
                    navigator.geolocation.getCurrentPosition(position => {
                        // 새로운 위치를 가져온 후에 이전 위치 초기화
                        const { latitude, longitude } = position.coords;

                        // 검색한 장소(searchedLat)와 사용자의 위치(latitude, longitude)사이의 거리를 계산합니다.
                        var distance = Math.sqrt(Math.pow(latitude - searchedLat, 2) + Math.pow(longitude - searchedLng, 2));

                        // 검색 결과를 표시할 div 요소와 지도를 담을 div 요소를 가져옴.
                        var resultDiv = document.getElementById('result');
                        var mapContainer = document.getElementById('map');

                        // 기능 변경 예정) 여기 부분에서 if면 작성 기능, else면 작성 불가.
                        if (distance < 0.011) { // 임의의 거리 설정 [0.01 = 1km]
                            resultDiv.innerHTML = "해당 지역 리뷰 작성이 가능합니다.";
                            document.getElementById('reviewInput').style.display = "block"; // 리뷰 입력 창 표시
                        } else {
                            resultDiv.innerHTML = "해당 지역 리뷰 작성이 불가합니다.";
                            document.getElementById('reviewInput').style.display = "none"; // 리뷰 입력 창 숨김
                        }

                        // 지도 표시
                        var mapOption = {
                            center: new kakao.maps.LatLng(searchedLat, searchedLng), // 검색한 장소를 중심으로 지도 표시
                            level: 5 // 지도의 확대 레벨
                        };

                        // 지도 생성
                        var map = new kakao.maps.Map(mapContainer, mapOption);

                        // 마커 표시
                        var markerPosition = new kakao.maps.LatLng(searchedLat, searchedLng);
                        var marker = new kakao.maps.Marker({
                            position: markerPosition
                        });

                        // 마커를 지도에 표시
                        marker.setMap(map);
                    }, error => {
                        console.error('Error getting location:', error);
                    });
                } else {
                    alert('도로명주소 검색으로 정보를 찾을 수 있습니다.');
                }
            });
        }

        function postReview() {
            var reviewContent = document.getElementById('reviewTextArea').value;
            // 리뷰 내용을 서버로 전송합니다.
            fetch('/comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ comment: reviewContent })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok.');
            })
            .then(data => {
                // 서버로부터의 응답을 처리합니다.
                console.log(data);
                alert('리뷰가 작성되었습니다: ' + reviewContent);
                // 페이지를 새로고침합니다.
                window.location.reload();
            })
            .catch(error => {
                console.error('There was an error!', error);
            });
        }
    </script>

</body>

</html>
